"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[5781],{5781:(Q,p,a)=>{a.r(p),a.d(p,{Tab3PageModule:()=>L});var c=a(9843),b=a(6814),u=a(95),T=a(2881),g=a(5861),e=a(9468),y=a(9862),F=a(2377),A=a(6306),x=a(6232),k=a(553),S=a(7793),E=a(5517),I=a(7696),Z=a(7519);const O=k.N.url;let _=(()=>{var t;class s{constructor(o,i,n,m){this.http=o,this.indexdbService=i,this.usuarioService=n,this.turnoSaeIndexdbService=m,this.token="",this.eventoSaeModel=new S.b,this.indexdbService.openDatabase().then(v=>{this.db=v,console.log("INICIO BASE DE DATOS EN EVENTOS-SAE")}).catch(v=>{console.error("Error al inicializar la base de datos:",v)})}formatearFecha(o){return(0,F.Z)(o,"dd/MM/yyyy HH:mm")}EnviarTurno(o){var i=this;return(0,g.Z)(function*(){return yield i.usuarioService.cargarToken(),i.token=i.usuarioService.token,new Promise(n=>{const m=new y.WM({Authorization:`Bearer ${i.token}`});console.log("DATOS TURNOS SAE:",o),i.http.post(`${O}/turnos-sae`,o,{headers:m,observe:"response"}).pipe((0,A.K)(v=>(n(!1),console.error("Error en la solicitud HTTP turnos-sae:",v.error.message),x.E))).subscribe(function(){var v=(0,g.Z)(function*(r){const f=r.status,h=r.headers;console.log("responseBody:",r.body),console.log("status:",f),console.log("headers:",h),n(!!r)});return function(r){return v.apply(this,arguments)}}())})})()}}return(t=s).\u0275fac=function(o){return new(o||t)(e.LFG(y.eN),e.LFG(E.p),e.LFG(I.i),e.LFG(Z.N))},t.\u0275prov=e.Yz7({token:t,factory:t.\u0275fac,providedIn:"root"}),s})();var D=a(4734),N=a(7830),P=a(1327);function C(t,s){if(1&t&&(e.TgZ(0,"ion-select-option",14),e._uU(1),e.qZA()),2&t){const l=s.$implicit;e.Q6J("disabled",!0)("value",l.codigo),e.xp6(1),e.Oqu(l.nombre)}}function J(t,s){if(1&t&&(e.TgZ(0,"ion-select-option",14),e._uU(1),e.qZA()),2&t){const l=s.$implicit;e.Q6J("disabled",!0)("value",l.codigo),e.xp6(1),e.Oqu(l.horario)}}function U(t,s){if(1&t&&(e.TgZ(0,"ion-select-option",14),e._uU(1),e.qZA()),2&t){const l=s.$implicit;e.Q6J("disabled",!0)("value",l.patente),e.xp6(1),e.Oqu(l.patente)}}function M(t,s){if(1&t&&(e.TgZ(0,"ion-select-option",14),e._uU(1),e.qZA()),2&t){const l=s.$implicit;e.Q6J("disabled",!0)("value",l.rut_ayudante),e.xp6(1),e.Oqu(l.nombre)}}const Y=[{path:"",component:(()=>{var t;class s{constructor(o,i,n,m,v,r,d,f,h,V){this.sharedService=o,this.indexdbService=i,this.navCtrl=n,this.usuarioService=m,this.turnosaeIndexdbService=v,this.eventoSaeIndexdbService=r,this.uiService=d,this.formBuilder=f,this.loadingCtrl=h,this.toastController=V,this.listaAyudantes=[],this.listaOficinas=[],this.listaVehiculos=[],this.listaTurnos=[],this.eventosEnviados=[],this.kmfinal="",this.turnosae=new S.b,this.turnoSaeService=(0,e.f3M)(_),this.miFormulario=this.formBuilder.group({id:[""],codigo_oficina:["",u.kI.required],codigo_turno:["",u.kI.required],patente_vehiculo:["",u.kI.required],rut_ayudante:["",u.kI.required],km_inicia:["",u.kI.required],km_final:["",u.kI.required]})}ngOnInit(){this.indexdbService.openDatabase().then(o=>{this.db=o,console.log("Cargar turno sae"),this.loadItemsFromIndexDB(),this.ObtenerRegistrodeTurno(),this.ObtenerEstadoEnvioEventos()}).catch(o=>{console.error("Error al inicializar la base de datos:",o)}),this.sharedService.updateList$.subscribe(()=>{console.log("sharedService.updateList"),this.ObtenerRegistrodeTurno()})}ionViewWillLeave(){console.log("ionViewWillLeave")}ionViewDidLeave(){console.log("ionViewDidLeave")}ionViewDidEnter(){console.log("ionViewDidEnter 1")}ionViewWillEnter(){console.log("ionViewWillEnter"),this.indexdbService.openDatabase().then(o=>{this.db=o,console.log("Cargar turno sae"),this.loadItemsFromIndexDB(),this.ObtenerRegistrodeTurno(),this.ObtenerEstadoEnvioEventos()}).catch(o=>{console.error("Error al inicializar la base de datos:",o)})}ObtenerEstadoEnvioEventos(){var o=this;return(0,g.Z)(function*(){yield o.eventoSaeIndexdbService.getEventosByEstadoEnvio(0).then(i=>{o.eventosEnviados=i,console.log("Eventos No Enviados",o.eventosEnviados.length)}).catch(i=>{console.error("Error al obtener el turno:",i)})})()}ObtenerRegistrodeTurno(){var o=this;return(0,g.Z)(function*(){yield o.turnosaeIndexdbService.getTurnosae(1).then(n=>{n?(o.miFormulario.patchValue({id:n.id,codigo_oficina:n.codigo_oficina,codigo_turno:n.codigo_turno,patente_vehiculo:n.patente_vehiculo,rut_ayudante:n.rut_ayudante,km_inicia:n.km_inicia,km_final:n.km_final}),n.km_final&&(o.kmfinal=n.km_final.toString())):console.log("No se encontr\xf3 el turno con ID 1")}).catch(n=>{console.error("Error al obtener el turno:",n)})})()}presentToast(o){var i=this;return(0,g.Z)(function*(){yield(yield i.toastController.create({message:o,duration:2e3,position:"bottom"})).present()})()}loadItemsFromIndexDB(){var o=this;return(0,g.Z)(function*(){const i=["ayudantes","oficinas","vehiculos","turnos"];for(const n of i)yield o.loadItems(n)})()}loadItems(o){var i=this;return(0,g.Z)(function*(){try{const n=yield i.indexdbService.getAllFromIndex(o);i.assignItemsToList(o,n),console.log(`${o} obtenidos:`,n)}catch(n){console.error(`Error al obtener ${o}:`,n)}})()}assignItemsToList(o,i){switch(o){case"ayudantes":this.listaAyudantes=i;break;case"oficinas":this.listaOficinas=i;break;case"vehiculos":this.listaVehiculos=i;break;case"turnos":this.listaTurnos=i}}guardarFinTurno(){var o=this;return(0,g.Z)(function*(){var i;if(null!==(i=o.miFormulario)&&void 0!==i&&i.valid){const{id:n,km_final:m}=o.miFormulario.value;console.log("Id del registro creado : ",n);const v=yield o.loadingCtrl.create({message:"Guardando..."});v.present();try{let r=yield o.turnosaeIndexdbService.getTurnosae(n);console.log("Turno",r),r.km_final=m,r.fecha_hora_final=new Date,r&&(console.log("Datos Actualizados en IndexDB:",r),o.turnosaeIndexdbService.actualizarTurnosae(r).then(()=>{console.log("Datos Actualizados en IndexDB:",r)})),o.ObtenerRegistrodeTurno(),yield o.presentToast("Los datos fueron actualizados")}catch{}finally{v.dismiss()}}else console.log("Formulario inv\xe1lido. Por favor, complete todos los campos."),yield o.presentToast("Formulario inv\xe1lido. Por favor, complete todos los campos.")})()}enviarTurnoaMongoDb(){var o=this;return(0,g.Z)(function*(){var i;let n=o.turnosae;if(null!==(i=o.miFormulario)&&void 0!==i&&i.valid){const{id:m}=o.miFormulario.value;console.log("Id del registro creado turno : ",m);const v=yield o.loadingCtrl.create({message:"Enviando..."});v.present();try{yield o.turnosaeIndexdbService.getTurnosae(m).then(d=>{d?n={rut_maestro:d.rut_maestro,codigo_turno:d.codigo_turno,rut_ayudante:d.rut_ayudante,patente_vehiculo:d.patente_vehiculo,km_inicia:d.km_inicia.toString(),km_final:d.km_final.toString(),codigo_oficina:d.codigo_oficina,fecha_hora_inicio:d.fecha_hora_inicio,fecha_hora_final:d.fecha_hora_final,latitude:d.latitude,longitude:d.longitude}:console.log(`No se encontr\xf3 el turno con ID ${m}`)}).catch(d=>{console.error("Error al obtener el turno:",d)}),console.log("DATA",n),console.log("Enviando Datos desde Turno");const r=yield o.turnoSaeService.EnviarTurno(n);console.log("VALIDO",r),r&&(o.uiService.alertaInformativa("Este registro ha sido enviado al servidor"),o.usuarioService.logout()),0==r&&o.uiService.alertaInformativa("No es posible conectar con el servidor intentar m\xe1s tarde")}catch{}finally{v.dismiss()}}else console.log("Formulario inv\xe1lido. Por favor, complete todos los campos."),yield o.presentToast("Formulario inv\xe1lido.")})()}}return(t=s).\u0275fac=function(o){return new(o||t)(e.Y36(D.F),e.Y36(E.p),e.Y36(c.SH),e.Y36(I.i),e.Y36(Z.N),e.Y36(N._),e.Y36(P.y),e.Y36(u.qu),e.Y36(c.HT),e.Y36(c.yF))},t.\u0275cmp=e.Xpm({type:t,selectors:[["app-tab3"]],decls:34,vars:8,consts:[[1,"ion-padding",3,"fullscreen"],[3,"formGroup"],["formControlName","codigo_oficina","readonly","true","label","Oficina","label-placement","floating","fill","solid",3,"disabled"],[3,"disabled","value",4,"ngFor","ngForOf"],["formControlName","codigo_turno","label","Turno","label-placement","floating","fill","solid"],["formControlName","patente_vehiculo","label","Vehiculo","label-placement","floating","fill","solid"],["formControlName","rut_ayudante","label","Ayudante","label-placement","floating","fill","solid"],["type","text","readonly","true","formControlName","km_inicia","label","KM Inicial","label-placement","floating","fill","solid","placeholder",""],["type","number","required","","formControlName","km_final","label","KM Final","label-placement","floating","fill","outline","placeholder","Ingresar km final"],["id","guardarFinTurno","expand","full","color","primary",1,"bottom-button",3,"click"],["slot","start","name","save"],["id","enviarTurnoaMongoDb","expand","full","color","primary",1,"bottom-button",3,"disabled","click"],["slot","start","name","send"],["type","hidden","formControlName","id"],[3,"disabled","value"]],template:function(o,i){1&o&&(e.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),e._uU(3," Finalizar Turno "),e.qZA()()(),e.TgZ(4,"ion-content",0)(5,"ion-card")(6,"ion-card-content")(7,"form",1)(8,"ion-select",2),e.YNc(9,C,2,3,"ion-select-option",3),e.qZA(),e._UZ(10,"br"),e.TgZ(11,"ion-select",4),e.YNc(12,J,2,3,"ion-select-option",3),e.qZA(),e._UZ(13,"br"),e.TgZ(14,"ion-select",5),e.YNc(15,U,2,3,"ion-select-option",3),e.qZA(),e._UZ(16,"br"),e.TgZ(17,"ion-select",6),e.YNc(18,M,2,3,"ion-select-option",3),e.qZA(),e._UZ(19,"br")(20,"ion-input",7)(21,"br")(22,"ion-input",8)(23,"br"),e.TgZ(24,"ion-button",9),e.NdJ("click",function(){return i.guardarFinTurno()}),e._UZ(25,"ion-icon",10),e._uU(26," Guardar"),e.qZA(),e._UZ(27,"br"),e.TgZ(28,"ion-button",11),e.NdJ("click",function(){return i.enviarTurnoaMongoDb()}),e._UZ(29,"ion-icon",12),e._uU(30," Enviar"),e.qZA(),e.TgZ(31,"p"),e._uU(32,"* Es necesario enviar todos los eventos y tener el km final"),e.qZA(),e._UZ(33,"ion-input",13),e.qZA()()()()),2&o&&(e.xp6(4),e.Q6J("fullscreen",!0),e.xp6(3),e.Q6J("formGroup",i.miFormulario),e.xp6(1),e.Q6J("disabled",!0),e.xp6(1),e.Q6J("ngForOf",i.listaOficinas),e.xp6(3),e.Q6J("ngForOf",i.listaTurnos),e.xp6(3),e.Q6J("ngForOf",i.listaVehiculos),e.xp6(3),e.Q6J("ngForOf",i.listaAyudantes),e.xp6(10),e.Q6J("disabled",i.eventosEnviados.length>0||0===i.kmfinal.length))},dependencies:[c.YG,c.PM,c.FN,c.W2,c.Gu,c.gu,c.pK,c.t9,c.n0,c.wd,c.sr,c.as,c.QI,c.j9,b.sg,u._Y,u.JJ,u.JL,u.Q7,u.sg,u.u]}),s})()}];let B=(()=>{var t;class s{}return(t=s).\u0275fac=function(o){return new(o||t)},t.\u0275mod=e.oAB({type:t}),t.\u0275inj=e.cJS({imports:[T.Bz.forChild(Y),T.Bz]}),s})(),L=(()=>{var t;class s{}return(t=s).\u0275fac=function(o){return new(o||t)},t.\u0275mod=e.oAB({type:t}),t.\u0275inj=e.cJS({imports:[c.Pc,b.ez,u.u5,u.UX,B]}),s})()}}]);